# Check for a .configured file generated by configure script
ifeq ($(wildcard .configured),)
$(error You must run `./configure` before you can build.)
endif

BUILDTARGET ?=
ifeq ($(strip $(BUILDTARGET)),)
	TARGETARG:=
else
	TARGETARG:=--target=$(BUILDTARGET)
endif

BUILDLINKER ?=
ifeq ($(strip $(BUILDLINKER)),)
	LINKER:=
else
	LINKER:=-C linker=$(BUILDLINKER)
endif

RC = @RC@
CC = @CC@

ifneq ($(strip $(BUILDLINKER)),)
ifneq ($(strip $(BUILDLINKER)),$(CC))
$(warning Your CC and BUILDLINKER do not match. If this is intentional and you know what you're doing, just ignore this. Otherwise, we recommend setting CC and BUILDLINKER to the same thing.)
endif
endif

CONFIG ?=

ifeq ($(CONFIG),--release)
	ifeq ($(strip $(BUILDTARGET)),)
		COPY_RESULT = cp target/release/dproc bin/dproc
	else
		COPY_RESULT = cp target/$(BUILDTARGET)/release/dproc bin/dproc
	endif
else
	ifeq ($(strip $(BUILDTARGET)),)
		COPY_RESULT = cp target/debug/dproc bin/dproc
	else
		COPY_RESULT = cp target/$(BUILDTARGET)/debug/dproc bin/dproc
	endif
endif

INCLUDE_LIBMYSOLVERS = @INCLUDE_LIBMYSOLVERS@

CARGO = @CARGO@
RUSTFLAGS += -Anon_snake_case
RUSTFLAGS += $(LINKER)
CPPFLAGS ?=
CFLAGS ?=
LDFLAGS ?=
BIN = bin/dproc
BINDIR = bin
SRC = src/main.rs
PREFIX ?= @PREFIX@
NOREMOVELIBMYSOLVERSPREFIXES = /usr /usr/local /opt/local /opt/homebrew
GNSRCDIR ?= /tmp/e10b5eccac1ecb4e8706e3898719b197a1e9d10d65e860192d38155cb31233ea

all: build

build: src/*
	mkdir -p bin
	$(MAKE) build-libmysolvers
	RUSTFLAGS="$(RUSTFLAGS)" RUSTC="$(RC)" $(CARGO) build $(TARGETARG) $(CONFIG)
	$(COPY_RESULT)

build-libmysolvers:
	mkdir -p obj
	$(CC) $(CPPFLAGS) $(CFLAGS) -c lib/libmysolvers.c -o obj/libmysolvers.o
	ar rcs obj/libmysolvers.a obj/libmysolvers.o

upgrade-c-libs:
	cd lib && \
	curl -LO https://raw.githubusercontent.com/matthewyang204/libmysolvers/refs/heads/main/libmysolvers.c && \
	curl -LO https://raw.githubusercontent.com/matthewyang204/libmysolvers/refs/heads/main/libmysolvers.h

clean:
	rm -rf $(BINDIR)
	rm -rf dist
	rm -rf obj
	rm -rf target

install_libmysolvers:
ifeq ($(INCLUDE_LIBMYSOLVERS),TRUE)
	echo "Installing libmysolvers to $(PREFIX)..."
	mkdir -p $(PREFIX)/include
	mkdir -p $(PREFIX)/lib
	cp lib/libmysolvers.h $(PREFIX)/include/
	cp obj/libmysolvers.a $(PREFIX)/lib/
endif

install:
	echo "Installing dproc to $(PREFIX)..."
	mkdir -p $(PREFIX)/$(BINDIR)
	rm -rf $(PREFIX)/$(BIN)
	cp $(BIN) $(PREFIX)/$(BIN)
	$(MAKE) install_libmysolvers

uninstall:
	rm -rf $(PREFIX)/$(BIN)
ifeq ($(INCLUDE_LIBMYSOLVERS),TRUE)
ifeq ($(filter $(PREFIX),$(NOREMOVELIBMYSOLVERSPREFIXES)),)
	rm -rf $(PREFIX)/include/libmysolvers.h
	rm -rf $(PREFIX)/lib/libmysolvers.a
endif
endif

dist: clean
	rm -rf $(GNSRCDIR)
	cp -R . $(GNSRCDIR)
	mkdir -p dist
	find $(GNSRCDIR) -type d -name ".git" -print
	find $(GNSRCDIR) -type d -name ".git" -exec rm -rf {} +
	tar -cvJf dist/dproc-1.1.1.tar.xz -C $(GNSRCDIR) .
	rm -rf $(GNSRCDIR)

.PHONY: all build clean install uninstall
