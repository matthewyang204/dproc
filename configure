#!/bin/bash

# Check for rustc
printf "Checking for rustc..."
if ! command -v rustc &> /dev/null
then
    echo "not found"
    echo "rustc not found. Please install it to continue."
    exit 1
else
    echo "found"
fi

# Check for make
printf "Checking for make..."
if ! command -v make &> /dev/null
then
    echo "not found"
    echo "make not found. Please install it to continue."
    exit 1
else
    echo "found"
fi

# Check for a C compiler
printf "Checking for C compiler..."
if command -v gcc &> /dev/null
then
    CC=gcc
    echo "gcc"
elif command -v clang &> /dev/null
then
    CC=clang
    echo "clang"
elif command -v cc &> /dev/null
then
    CC=cc
    echo "cc"
else
    echo "not found"
    echo "No C compiler found. Please install gcc or clang to continue."
    exit 1
fi

# Check OS type in order to determine proper sed
# Detect OS and set sed -i syntax
if [[ "$OSTYPE" == "darwin"* ]]; then
    SED_INPLACE=("sed" "-i" "'/tmp/e10b5eccac1ecb4e8706e3898719b197a1e9d10d65e860192d38155cb31233ea'")
else
    SED_INPLACE=("sed" "-i")
fi

# Patching Makefile
echo "Creating usable Makefile..."
"${SED_INPLACE[@]}" "s|^CC ?= .*|CC = $CC|" Makefile
rm -rf /tmp/e10b5eccac1ecb4e8706e3898719b197a1e9d10d65e860192d38155cb31233ea

touch .configured
echo "Configuration complete. Run 'make' to build."
